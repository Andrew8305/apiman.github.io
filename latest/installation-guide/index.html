<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">apiman - Installation Guide</title><link rel="stylesheet" href="css/jbossorg.css" type="text/css"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL-NS Stylesheets V1.74.0"/><meta xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" http-equiv="Content-Type" content="text/html; charset=UTF-8"/></head><body><div class="book" lang="en-US"><div class="titlepage"><div><p xmlns:d="http://docbook.org/ns/docbook" id="title"><a href="http://www.jboss.org" class="site_href"><strong>JBoss.org</strong></a><a href="http://docs.jboss.org/" class="doc_href"><strong>Community Documentation</strong></a></p><div><h1 class="title"><a id="d0e3"/>apiman - Installation Guide</h1></div></div><hr/></div><div class="toc"><dl><dt><span class="chapter"><a href="#_installation">1. Installation</a></span></dt><dd><dl><dt><span class="section"><a href="#_installing_in_wildfly_8">1.1. Installing in WildFly 8</a></span></dt><dd><dl><dt><span class="section"><a href="#_download">1.1.1. Download</a></span></dt><dt><span class="section"><a href="#_unpack">1.1.2. Unpack</a></span></dt><dt><span class="section"><a href="#_run_wildfly_8">1.1.3. Run WildFly 8</a></span></dt></dl></dd><dt><span class="section"><a href="#_installing_using_docker">1.2. Installing using Docker</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_logging_in">2. Logging In</a></span></dt><dt><span class="chapter"><a href="#_general_configuration">3. General Configuration</a></span></dt><dd><dl><dt><span class="section"><a href="#_configuration_properties">3.1. Configuration Properties</a></span></dt><dt><span class="section"><a href="#_api_manager_database">3.2. API Manager Database</a></span></dt><dt><span class="section"><a href="#_api_gateway_registry">3.3. API Gateway Registry</a></span></dt><dt><span class="section"><a href="#_api_gateway_rate_limiter">3.4. API Gateway Rate Limiter</a></span></dt><dt><span class="section"><a href="#_api_gateway_shared_state">3.5. API Gateway Shared State</a></span></dt><dt><span class="section"><a href="#_gateway_api_authentication">3.6. Gateway API Authentication</a></span></dt></dl></dd><dt><span class="chapter"><a href="#_howtos">4. HowTos</a></span></dt><dd><dl><dt><span class="section"><a href="#_how_to_use_elasticsearch_instead_of_an_rdbms_in_the_api_manager">4.1. How To:  Use Elasticsearch instead of an RDBMS in the API Manager</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview">4.1.1. High Level Overview</a></span></dt><dt><span class="section"><a href="#_download_and_install_elasticsearch">4.1.2. Download and install Elasticsearch</a></span></dt><dt><span class="section"><a href="#_make_changes_to_apiman_properties">4.1.3. Make changes to "apiman.properties"</a></span></dt><dt><span class="section"><a href="#__re_start_apiman">4.1.4. (Re)start apiman</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_use_elasticsearch_instead_of_infinispan_in_the_api_gateway">4.2. How To:  Use Elasticsearch instead of Infinispan in the API Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_2">4.2.1. High Level Overview</a></span></dt><dt><span class="section"><a href="#_download_and_install_elasticsearch_2">4.2.2. Download and install Elasticsearch</a></span></dt><dt><span class="section"><a href="#_make_changes_to_apiman_properties_2">4.2.3. Make changes to "apiman.properties"</a></span></dt><dt><span class="section"><a href="#__re_start_apiman_2">4.2.4. (Re)start apiman</a></span></dt></dl></dd></dl></dd></dl></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_installation"/>Chapter 1. Installation</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_installing_in_wildfly_8">1.1. Installing in WildFly 8</a></span></dt><dd><dl><dt><span class="section"><a href="#_download">1.1.1. Download</a></span></dt><dt><span class="section"><a href="#_unpack">1.1.2. Unpack</a></span></dt><dt><span class="section"><a href="#_run_wildfly_8">1.1.3. Run WildFly 8</a></span></dt></dl></dd><dt><span class="section"><a href="#_installing_using_docker">1.2. Installing using Docker</a></span></dt></dl></div><p>This guide provides detailed information about how to install and configure apiman.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_installing_in_wildfly_8"/>1.1. Installing in WildFly 8</h2></div></div></div><p>The apiman project primarily targets WildFly 8 as a runtime environment.  In order to install
apiman you will need to download both WildFly 8 and the apiman overlay distribution.  Once
both are downloaded, it’s a simple matter of unpacking both into the same location.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_download"/>1.1.1. Download</h3></div></div></div><p>First you will need to download both WildFly 8 and apiman:</p><div class="itemizedlist"><ul><li><a class="ulink" href="http://download.jboss.org/wildfly/8.2.0.Final/wildfly-8.2.0.Final.zip">Download WildFly 8</a></li><li><a class="ulink" href="http://downloads.jboss.org/overlord/apiman/1.1.3.Final/apiman-distro-wildfly8-1.1.3.Final-overlay.zip">Download apiman 1.1.3.Final</a></li></ul></div><pre class="literallayout">curl http://download.jboss.org/wildfly/8.2.0.Final/wildfly-8.2.0.Final.zip -o wildfly-8.2.0.Final.zip
curl http://downloads.jboss.org/overlord/apiman/1.1.3.Final/apiman-distro-wildfly8-1.1.3.Final-overlay.zip -o apiman-distro-wildfly8-1.1.3.Final-overlay.zip</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_unpack"/>1.1.2. Unpack</h3></div></div></div><p>Once both files have been downloaded, simply unpack both in the same location.</p><pre class="literallayout">unzip wildfly-8.2.0.Final.zip
unzip -o apiman-distro-wildfly8-1.1.3.Final-overlay.zip -d wildfly-8.2.0.Final</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_run_wildfly_8"/>1.1.3. Run WildFly 8</h3></div></div></div><p>The apiman overlay contains everything needed to run apiman, including:</p><div class="itemizedlist"><ul><li>apiman binaries (several WAR files)</li><li>apiman-specific WildFly 8 configuration (<span class="strong"><strong>standalone-apiman.xml</strong></span>)</li><li>apiman rdbms datasource (h2)</li><li>pre-configured <span class="strong"><strong>admin</strong></span> user with password <span class="strong"><strong>admin123!</strong></span></li><li>pre-configured h2 database for the API Manager (populated with default values)</li></ul></div><p>For this reason, there is no additional configuration required to run apiman.  Simply start up
WildFly using the apiman configuration file:</p><pre class="literallayout">cd wildfly-8.2.0.Final
./bin/standalone.sh -c standalone-apiman.xml</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_installing_using_docker"/>1.2. Installing using Docker</h2></div></div></div><p>Another option when installing apiman is to use our docker image.  You’re probably pretty
familiar with docker if you’re going that route, but here is an example of how to start up
the apiman docker image:</p><pre class="literallayout">docker pull apiman/on-wildfly8
docker run -it -p 8080:8080 apiman/on-wildfly8</pre><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>You can find apiman on <a class="ulink" href="https://registry.hub.docker.com/repos/apiman/">docker hub</a>.</p></div></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_logging_in"/>Chapter 2. Logging In</h2></div></div></div><p>Once apiman is running, you should be able to log in to the API Manager by pointing your
browser at the following URL:</p><pre class="literallayout">http://localhost:8080/apimanui/</pre><p>You may log in with credentials <span class="strong"><strong>admin/admin123!</strong></span>.</p><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="note"><h2>Note</h2><p>We strongly advise that you immediately change the Keycloak admin user password, as well
as the "admin" user found in the "apiman" realm!!  ( you can do that by navigating to
<a class="ulink" href="http://localhost:8080/auth/admin/">http://localhost:8080/auth/admin/</a> )</p></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_general_configuration"/>Chapter 3. General Configuration</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_configuration_properties">3.1. Configuration Properties</a></span></dt><dt><span class="section"><a href="#_api_manager_database">3.2. API Manager Database</a></span></dt><dt><span class="section"><a href="#_api_gateway_registry">3.3. API Gateway Registry</a></span></dt><dt><span class="section"><a href="#_api_gateway_rate_limiter">3.4. API Gateway Rate Limiter</a></span></dt><dt><span class="section"><a href="#_api_gateway_shared_state">3.5. API Gateway Shared State</a></span></dt><dt><span class="section"><a href="#_gateway_api_authentication">3.6. Gateway API Authentication</a></span></dt></dl></div><p>Of course apiman is made up of a number of different components, many of which can be configured
to use various implementations and/or providers.  When downloading and installing apiman, the
default distribution includes reasonable default values for all options.  This section details
these options and explains the default values.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_configuration_properties"/>3.1. Configuration Properties</h2></div></div></div><p>All of the apiman WARs share a common configuration file called <span class="strong"><strong>apiman.properties</strong></span>, which can
be found in <span class="strong"><strong>standalone/configuration</strong></span>.  This file therefore contains configuration settings
for all three applications (API Manager, API Manager UI, API Gateway).</p><p>Here is a breakdown of the properties found in this configuration file:</p><div class="itemizedlist"><ul><li><p><span class="strong"><strong>apiman.plugins.repositories</strong></span></p><div class="variablelist"><dl><dt><span class="term">Typical Value</span></dt><dd><a class="ulink" href="http://repository.jboss.org/nexus/content/groups/public/">http://repository.jboss.org/nexus/content/groups/public/</a></dd><dt><span class="term">Description</span></dt><dd>A comma separated list of maven repositories from which to (try to) download apiman plugins.</dd></dl></div></li><li><p><span class="strong"><strong>apiman-manager-ui.api.endpoint</strong></span></p><div class="variablelist"><dl><dt><span class="term">Typical Value</span></dt><dd>&lt;empty&gt;</dd><dt><span class="term">Description</span></dt><dd>The public endpoint of the API Manager’s REST API.  This is used by the API Manager UI to communicate with the back end.  If ommitted, the UI will assume the back-end is located on the same server as the UI.</dd></dl></div></li><li><p><span class="strong"><strong>apiman-manager-ui.api.authentication.type</strong></span></p><div class="variablelist"><dl><dt><span class="term">Typical Value</span></dt><dd>bearerToken</dd><dt><span class="term">Description</span></dt><dd>The type of authentication used by the API Manager UI when communicating with the API Manager.</dd></dl></div></li><li><p><span class="strong"><strong>apiman-manager-ui.api.authentication.token.generator</strong></span></p><div class="variablelist"><dl><dt><span class="term">Typical Value</span></dt><dd>io.apiman.manager.ui.server.wildfly8.KeyCloakBearerTokenGenerator</dd><dt><span class="term">Description</span></dt><dd>The class used by the UI to generate authentication tokens (only used for certain types of authentication).</dd></dl></div></li><li><p><span class="strong"><strong>apiman-gateway.registry</strong></span></p><div class="variablelist"><dl><dt><span class="term">Typical Value</span></dt><dd>io.apiman.gateway.engine.ispn.InfinispanRegistry</dd><dt><span class="term">Description</span></dt><dd>The implementation of the service/application registry used by the API Gateway.  By default a persistent Infinispan cache is used.</dd></dl></div></li><li><p><span class="strong"><strong>apiman-gateway.connector-factory</strong></span></p><div class="variablelist"><dl><dt><span class="term">Typical Value</span></dt><dd>io.apiman.gateway.platforms.servlet.connectors.HttpConnectorFactory</dd><dt><span class="term">Description</span></dt><dd>The implementation of a connector factory for API endpoints of type "http".  This factory is used by the Gateway when proxying a request to a back-end endpoint.</dd></dl></div></li><li><p><span class="strong"><strong>apiman-gateway.policy-factory</strong></span></p><div class="variablelist"><dl><dt><span class="term">Typical Value</span></dt><dd>io.apiman.gateway.engine.policy.PolicyFactoryImpl</dd><dt><span class="term">Description</span></dt><dd>The class that the API Gateway will use creating policies.</dd></dl></div></li><li><p><span class="strong"><strong>apiman-gateway.components.ISharedStateComponent</strong></span></p><div class="variablelist"><dl><dt><span class="term">Typical Value</span></dt><dd>io.apiman.gateway.engine.ispn.InfinispanSharedStateComponent</dd><dt><span class="term">Description</span></dt><dd>The implementation of the shared-state component - a component that can store arbitrary state across request invocations.</dd></dl></div></li><li><p><span class="strong"><strong>apiman-gateway.components.IRateLimiterComponent</strong></span></p><div class="variablelist"><dl><dt><span class="term">Typical Value</span></dt><dd>io.apiman.gateway.engine.ispn.InfinispanRateLimiterComponent</dd><dt><span class="term">Description</span></dt><dd>The implementation of the rate limiter component, which is used by the rate limiting policy.</dd></dl></div></li><li><p><span class="strong"><strong>apiman-gateway.components.IPolicyFailureFactoryComponent</strong></span></p><div class="variablelist"><dl><dt><span class="term">Typical Value</span></dt><dd>io.apiman.gateway.platforms.servlet.PolicyFailureFactoryComponent</dd><dt><span class="term">Description</span></dt><dd>The implementation class to use for the factory that creates policy failures.</dd></dl></div></li></ul></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_api_manager_database"/>3.2. API Manager Database</h2></div></div></div><p>The API Manager, by default, is a typical CDI application and uses JPA/Hibernate to persist its data.  The
JPA layer requires a data source to connect to a supported database.  When running in WildFly this
datasource is made available by deploying the following file:</p><pre class="literallayout">standalone/deployments/apiman-ds.xml</pre><p>Out of the box this data source is usually a simple H2 configuration, but you can (of course) change
it to support whatever database you desire.</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_processing_instruction">&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;UTF-8&quot;?&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">datasources</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">datasource</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">jndi-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;jdbc/ApiManDT&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">pool-name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;apiman-manager-api&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">enabled</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_attribute_name">use-java-context</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">connection-url</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">jdbc:h2:${jboss.server.data.dir}${/}h2${/}apiman-manager-api;MVCC=true</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">connection-url</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">driver</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">h2</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">driver</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">security</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">user-name</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain">sa</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">user-name</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">security</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">datasource</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">datasources</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>The project comes with DDLs for MySQL and PostgreSQL, to hopefully make it easy to switch away from H2.  Note
that switching databases also requires a change to the standalone-apiman.xml file.  The following
should be changed to appropriate values for your database:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">system-properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;apiman.hibernate.dialect&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;org.hibernate.dialect.MySQL5Dialect&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">property</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;apiman.hibernate.hbm2ddl.auto&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">value</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;validate&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">system-properties</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>You can, of course, set the hbm2ddl property to "update" so that hibernate automatically creates the
database structure when it starts up.  Alternatively, the MySQL and PostgreSQL DDLs can be found in
<span class="strong"><strong>apiman/ddls/</strong></span>.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_api_gateway_registry"/>3.3. API Gateway Registry</h2></div></div></div><p>The API Gateway includes a registry that stores the published service and application information.
This registry is updated whenever a user publishes a service (or registers an application) from
within the API Manager UI.  The registry contains just the configuration information necessary for
the API Gateway to properly apply the appropriate policies to all inbound requests.</p><p>Out of the box, the API Gateway is configured to use a persistent Infinispan cache to store the
published/registered data.  The configuration of the Infinispan cache can be found in
<span class="strong"><strong>standalone-apiman.xml</strong></span> and is detailed here:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">subsystem</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;urn:jboss:domain:infinispan:2.0&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">cache-container</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;apiman-gateway&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">default-cache</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;registry&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">start</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;EAGER&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">local-cache</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;registry&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">batching</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">file-store</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">passivation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;false&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">purge</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;false&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">local-cache</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">cache-container</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">subsystem</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre><p>This cache can be configured however you choose, but in all cases should be made persistent.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_api_gateway_rate_limiter"/>3.4. API Gateway Rate Limiter</h2></div></div></div><p>Part of the running apiman system is a "Rate Limiter" component.  This component is used by
apiman policies to enforce rate limits and uses an Infinispan cache to store data.  The
configuration of the Infinispan cache can be found in <span class="strong"><strong>standalone-apiman.xml</strong></span> and is
detailed here:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">subsystem</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;urn:jboss:domain:infinispan:2.0&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">cache-container</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;apiman-gateway&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">default-cache</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;registry&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">start</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;EAGER&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">local-cache</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;rate-limiter&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">batching</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">file-store</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">passivation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;false&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">purge</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;false&quot;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">local-cache</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">cache-container</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">subsystem</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_api_gateway_shared_state"/>3.5. API Gateway Shared State</h2></div></div></div><p>Part of the running apiman system is a "Shared State" component.  This component is used by
apiman policies to share interesting state information across multiple requests.  The
shared state component uses another Infinispan cache to store data.  The
configuration of the Infinispan cache can be found in <span class="strong"><strong>standalone-apiman.xml</strong></span> and is
detailed here:</p><pre xmlns="" xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="XML"><!-- XML : generated by JHighlight v1.0 (http://jhighlight.dev.java.net) -->
<span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">subsystem</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">xmlns</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;urn:jboss:domain:infinispan:2.0&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">cache-container</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;apiman-gateway&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">default-cache</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;registry&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">start</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;EAGER&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">local-cache</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">name</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;shared-state&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">batching</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;true&quot;</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;</span><span class="xml_tag_name">file-store</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">passivation</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;false&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_attribute_name">purge</span><span class="xml_tag_symbols">=</span><span class="xml_attribute_value">&quot;false&quot;</span><span class="xml_plain">&nbsp;</span><span class="xml_tag_symbols">/&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">local-cache</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_plain">&nbsp;&nbsp;</span><span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">cache-container</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
<span class="xml_tag_symbols">&lt;/</span><span class="xml_tag_name">subsystem</span><span class="xml_tag_symbols">&gt;</span><span class="xml_plain"></span><br />
</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_gateway_api_authentication"/>3.6. Gateway API Authentication</h2></div></div></div><p>The Gateway’s REST API is what the API Manager invokes when publishing services and applications
to the Gateway.  This REST API should be protected, often using BASIC authentication.  By default,
the Gateway REST API requires BASIC authentication credentials, as well as a role of <span class="strong"><strong>apipublisher</strong></span>.
In other words, the Gateway REST API can only be invoked by a valid user, and that user must have
the <span class="strong"><strong>apipublisher</strong></span> role.</p></div></div><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_howtos"/>Chapter 4. HowTos</h2></div></div></div><div class="toc"><dl><dt><span class="section"><a href="#_how_to_use_elasticsearch_instead_of_an_rdbms_in_the_api_manager">4.1. How To:  Use Elasticsearch instead of an RDBMS in the API Manager</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview">4.1.1. High Level Overview</a></span></dt><dt><span class="section"><a href="#_download_and_install_elasticsearch">4.1.2. Download and install Elasticsearch</a></span></dt><dt><span class="section"><a href="#_make_changes_to_apiman_properties">4.1.3. Make changes to "apiman.properties"</a></span></dt><dt><span class="section"><a href="#__re_start_apiman">4.1.4. (Re)start apiman</a></span></dt></dl></dd><dt><span class="section"><a href="#_how_to_use_elasticsearch_instead_of_infinispan_in_the_api_gateway">4.2. How To:  Use Elasticsearch instead of Infinispan in the API Gateway</a></span></dt><dd><dl><dt><span class="section"><a href="#_high_level_overview_2">4.2.1. High Level Overview</a></span></dt><dt><span class="section"><a href="#_download_and_install_elasticsearch_2">4.2.2. Download and install Elasticsearch</a></span></dt><dt><span class="section"><a href="#_make_changes_to_apiman_properties_2">4.2.3. Make changes to "apiman.properties"</a></span></dt><dt><span class="section"><a href="#__re_start_apiman_2">4.2.4. (Re)start apiman</a></span></dt></dl></dd></dl></div><p>This section contains specific instructions for how to configure apiman for specific scenarios.
For example, it is possible to use Elasticsearch instead of Infinispan for certain API Gateway
components.  This section details how to make these sorts of changes.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_how_to_use_elasticsearch_instead_of_an_rdbms_in_the_api_manager"/>4.1. How To:  Use Elasticsearch instead of an RDBMS in the API Manager</h2></div></div></div><p>The apiman quickstart is configured (by default) to use JPA as the persistence technology for
storing all of its data.  But this isn’t the only persistence technology supported.  Another
option is to use Elasticsearch instead.  This section details how to set up apiman for this
use-case.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_high_level_overview"/>4.1.1. High Level Overview</h3></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>Download and install <a class="ulink" href="https://www.elastic.co/downloads/elasticsearch">Elasticsearch</a></li><li>Make changes to "apiman.properties" to switch from JPA to Elasticsearch</li><li>(Re)start apiman!</li><li>Perform standard admin configuration of apiman (the database will of course be empty!)</li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_download_and_install_elasticsearch"/>4.1.2. Download and install Elasticsearch</h3></div></div></div><p>This part is pretty easy - download the Elasticsearch software and get it running.  A very good
resource for this can be found here:</p><p><a class="ulink" href="http://www.elastic.co/guide/en/elasticsearch/guide/master/getting-started.html">http://www.elastic.co/guide/en/elasticsearch/guide/master/getting-started.html</a></p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_make_changes_to_apiman_properties"/>4.1.3. Make changes to "apiman.properties"</h3></div></div></div><p>Once Elasticsearch is running smoothly, you must make some changes to the <span class="strong"><strong>apiman.properties</strong></span>
file in order to tell apiman to use ES instead of a database.  You should modify the
apiman.properties file to have the following properties set:</p><pre class="screen">apiman.es.host=
apiman.es.port=
apiman.es.cluster-name=
apiman-manager.storage.type=es
apiman-manager.storage.es.host=${apiman.es.host}
apiman-manager.storage.es.port=${apiman.es.port}
apiman-manager.storage.es.cluster-name=${apiman.es.cluster-name}
apiman-manager.storage.es.initialize=true</pre><p>Make sure you enter appropriate values for the apiman.es.host, apiman.es.port, and apiman.es.cluster-name
properties.  These values should reflect the settings of your Elasticsearch installation.</p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="__re_start_apiman"/>4.1.4. (Re)start apiman</h3></div></div></div><p>If apiman was running, you should stop it now.  Once everything is shutdown, and the changes
to apiman.properties have been made, go ahead and start apiman up again.  It will pick up the
new settings in apiman.properties and attempt to use Elasticsearch instead of the database!</p><h5 xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="formalpara">Perform standard admin configuration</h5><p class="formalpara">Note that the apiman quickstart comes pre-configured with a number of settings, including:</p><div class="itemizedlist"><ul><li>Installed policy definitions</li><li>Default configured roles (Organization Owner, Service Developer, Appliation Developer)</li><li>A default configured Gateway</li></ul></div><p>This built-in configuration will be lost when you switch from JPA to Elasticsearch.  You will
need to use the apiman admin UI to reconfigure these settings.  Refer to the "System Administration"
section of the User Guide for more information on this.</p></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="_how_to_use_elasticsearch_instead_of_infinispan_in_the_api_gateway"/>4.2. How To:  Use Elasticsearch instead of Infinispan in the API Gateway</h2></div></div></div><p>The apiman quickstart ships by default with an Infinispan based provider for various
runtime components in the API Gateway.  This includes, for example, the Rate Limiter
component which is used to track limits across a potential cluster of API Gateway
nodes (ensuring that the limits are consistent and effective despite traffic being
split across API Gateway nodes in a cluster).</p><p>The following components currently use Infinispan and can be switched to Elasticsearch:</p><div class="itemizedlist"><ul><li>API Gateway Registry (used to store the gateway configuration)</li><li>Rate Limiter Component (used to track limits)</li><li>Shared State Component (used by policies to share state across multiple requests)</li></ul></div><p>Each of these components can be configured separately.  So you can use Infinispan for
the last two but Elasticsearch for the first one, for example.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_high_level_overview_2"/>4.2.1. High Level Overview</h3></div></div></div><div xmlns:d="http://docbook.org/ns/docbook" xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" class="orderedlist"><ol><li>Download and install <a class="ulink" href="https://www.elastic.co/downloads/elasticsearch">Elasticsearch</a></li><li>Make changes to "apiman.properties" to switch from JPA to Elasticsearch</li><li>(Re)start apiman!</li></ol></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_download_and_install_elasticsearch_2"/>4.2.2. Download and install Elasticsearch</h3></div></div></div><p>This part is pretty easy - download the Elasticsearch software and get it running.  A very good
resource for this can be found here:</p><p><a class="ulink" href="http://www.elastic.co/guide/en/elasticsearch/guide/master/getting-started.html">http://www.elastic.co/guide/en/elasticsearch/guide/master/getting-started.html</a></p></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="_make_changes_to_apiman_properties_2"/>4.2.3. Make changes to "apiman.properties"</h3></div></div></div><p>Once Elasticsearch is running smoothly, you must make some changes to the <span class="strong"><strong>apiman.properties</strong></span>
file in order to tell apiman to use ES for the runtime components.</p><p>First, it’s often useful to set a common set of properties for the Elasticsearch
host, port, and cluster-name.  This way these properties can be re-used for the
configuration of each of the components.</p><pre class="screen">apiman-gateway.es.host=
apiman-gateway.es.port=
apiman-gateway.es.cluster-name=</pre><p>Make sure you enter appropriate values for the apiman.es.host, apiman.es.port, and apiman.es.cluster-name
properties.  These values should reflect the settings of your Elasticsearch installation.</p><p>Next, each of the components can be configured by changing/adding the following properties
in <span class="strong"><strong>apiman.properties</strong></span>.  Make sure any of the properties below which already have values
are removed before the ones below are copied in.</p><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_api_gateway_registry_2"/>4.2.3.1. API Gateway Registry</h4></div></div></div><p>Here is how you switch the API Gateway Registry over to Elasticsearch.</p><pre class="screen">apiman-gateway.registry=io.apiman.gateway.engine.es.ESRegistry
apiman-gateway.registry.client.type=transport
apiman-gateway.registry.client.cluster-name=${apiman-gateway.es.cluster-name}
apiman-gateway.registry.client.host=${apiman-gateway.es.host}
apiman-gateway.registry.client.port=${apiman-gateway.es.port}</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_rate_limiter_component"/>4.2.3.2. Rate Limiter Component</h4></div></div></div><p>Here is how you switch the Rate Limiter Component over to Elasticsearch.</p><pre class="screen">apiman-gateway.components.IRateLimiterComponent=io.apiman.gateway.engine.es.ESRateLimiterComponent
apiman-gateway.components.IRateLimiterComponent.client.type=transport
apiman-gateway.components.IRateLimiterComponent.client.cluster-name=${apiman-gateway.es.cluster-name}
apiman-gateway.components.IRateLimiterComponent.client.host=${apiman-gateway.es.host}
apiman-gateway.components.IRateLimiterComponent.client.port=${apiman-gateway.es.port}</pre></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="_shared_state_component"/>4.2.3.3. Shared State Component</h4></div></div></div><p>Here is how you switch the Shared State Component over to Elasticsearch.</p><pre class="screen">apiman-gateway.components.ISharedStateComponent=io.apiman.gateway.engine.es.ESSharedStateComponent
apiman-gateway.components.ISharedStateComponent.client.type=transport
apiman-gateway.components.ISharedStateComponent.client.cluster-name=${apiman-gateway.es.cluster-name}
apiman-gateway.components.ISharedStateComponent.client.host=${apiman-gateway.es.host}
apiman-gateway.components.ISharedStateComponent.client.port=${apiman-gateway.es.port}</pre></div></div><div class="section" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="__re_start_apiman_2"/>4.2.4. (Re)start apiman</h3></div></div></div><p>If apiman was running, you should stop it now.  Once everything is shutdown, and the changes
to apiman.properties have been made, go ahead and start apiman up again.  It will pick up the
new settings in apiman.properties and attempt to use Elasticsearch instead of Infinispan.</p></div></div></div></div></body></html>